# Система 3D Моделей в Городе MathTrainer

## Обзор

Система позволяет использовать GLB/GLTF 3D модели вместо простых геометрических примитивов для зданий в городе.

## Архитектура

### Основные компоненты:

1. **ModelLoader** (`src/utils/city/ModelLoader.ts`)
   - Загружает GLB/GLTF модели
   - Кэширует модели для производительности
   - Поддерживает анимации и материалы

2. **BuildingPrefabs** (`src/utils/city/BuildingPrefabs.ts`)
   - Управляет префабами зданий
   - Связывает шаблоны зданий с 3D моделями
   - Поддерживает вариации цвета и масштаба для разных уровней

3. **BuildingManager** (обновлён)
   - Использует новую систему для создания 3D зданий
   - Поддерживает fallback на простую геометрию

## Использование ваших GLB моделей

### 1. Размещение моделей

Положите GLB файлы в папку `public/3d/`:

```
public/3d/
├── old_small_hause.glb
├── another_building.glb
└── ...
```

### 2. Создание префаба

В `BuildingPrefabs.ts` добавьте новый префаб:

```typescript
this.addPrefab({
  id: 'my_house',
  templateId: 'small_house',
  modelConfig: {
    id: 'my_house_3d',
    modelPath: '/3d/my_model.glb',
    scale: new BABYLON.Vector3(1.0, 1.0, 1.0),
    rotation: new BABYLON.Vector3(0, 0, 0),
    offset: { x: 0, y: 0, z: 0 }
  },
  materialColors: {
    1: new BABYLON.Color3(1.0, 0.8, 0.4), // Уровень 1
    2: new BABYLON.Color3(0.8, 1.0, 0.4), // Уровень 2
    3: new BABYLON.Color3(1.0, 0.6, 0.2)  // Уровень 3
  }
})
```

### 3. Текущая интеграция

Ваша модель `old_small_hause.glb` уже интегрирована:
- Используется для "Маленького домика"
- Используется для "Коттеджа" (с другим масштабом)
- Разные цвета для уровней развития

## Особенности системы

### Автоматическое центрирование
Модели автоматически центрируются относительно начала координат

### Уровни зданий
Цвет материалов меняется в зависимости от уровня здания

### Fallback система
Если 3D модель не загрузится, система автоматически создаст здание из базовой геометрии

### Анимации
Система поддерживает анимации из GLB файлов

## Производительность

- Модели кэшируются после первой загрузки
- Повторные здания используют клонированные меши
- Оптимизировано для мобильных устройств

## Добавление новых моделей

1. Создайте GLB модель в 3D редакторе (Blender, 3ds Max и т.д.)
2. Экспортируйте с настройками:
   - Масштаб: 1 единица = 1 метр
   - Вертикальная ось: Y
   - Центрированная модель
3. Поместите в `public/3d/`
4. Добавьте префаб в `BuildingPrefabs.ts`

## Тестирование

Для тестирования 3D моделей:
1. Откройте приложение
2. Перейдите на страницу города
3. Постройте "Маленький домик" - должна появиться ваша GLB модель

## Устранение проблем

### Модель не загружается
- Проверьте путь к файлу в `modelPath`
- Убедитесь, что файл существует в `public/3d/`
- Проверьте консоль браузера на ошибки

### Модель отображается некорректно
- Проверьте масштаб модели
- Убедитесь, что модель центрирована
- Проверьте ориентацию осей

### Производительность
- Оптимизируйте полигонаж в 3D редакторе
- Используйте сжатые текстуры
- Ограничьте количество полигонов до 1000 для мобильных устройств