# PRD: Вычитание в столбик (Column Subtraction)

**Дата:** 7 февраля 2026
**Версия:** 1.0
**Статус:** Черновик

---

## 1. Executive Summary (Резюме)

**Vision:** Создать интерактивное упражнение "Вычитание в столбик" для учеников 2-3 классов, которое решает фундаментальную проблему непонимания концепции заимствования из старших разрядов и основного правила вычитания (из верхнего вычитаем нижнее).

**Ключевая ценность:** Использование метафоры "Магазин" (пачки конфет как десятки, отдельные конфеты как единицы) превращает абстрактную математическую операцию в понятную визуальную историю. Двухэтапная проверка знаний (обучение → диагностика → тренировка) гарантирует, что ребёнок не перейдёт к тренировке без твёрдого понимания материала.

**Интеграция:** Упражнение полностью следует существующим паттернам MathTrainer: использование `useGameLogic`, структура `MathProblem`, система монет и очков, маршрутизация через роутер.

---

## 2. Problem Statement (Постановка проблемы)

### 2.1 Основные проблемы

| Проблема | Описание | Последствия |
|----------|----------|-------------|
| **"Ловушка невозможности"** | Ребёнок видит 5-7 и считает это невозможным | Переворачивает числа, вычитает 7-5 |
| **Непонимание заимствования** | Не понимает, откуда берётся дополнительный десяток | Ошибки в примерах типа 52-17 |
| **Абстрактность концепции** | Занимание из разрядов — слишком абстрактно | Отсутствие интуитивного понимания |

### 2.2 Влияние на пользовательский опыт

- **Дети:** Формирование неверных паттернов вычисления, потеря уверенности в себе
- **Родители/Учителя:** Сложность объяснить концепцию без наглядных материалов

### 2.3 Метрики (гипотеза)

- ~60% учеников 2-3 классов делают ошибки в примерах с заимствованием
- ~40% ошибок связаны с "переворотом" чисел (вычитание нижнего из верхнего)

---

## 3. Goals & Metrics (Цели и метрики)

### 3.1 SMART цели

| ID | Цель | Метрика | Target | Приоритет |
|----|------|---------|--------|-----------|
| G-1 | Ученик понимает правило "из верхнего вычитаем нижнее" | Проход диагностики с 9/10 | >=80% учеников | P0 |
| G-2 | Ученик применяет заимствование корректно | Проход диагностики (примеры с заимствованием) | >=70% корректных ответов | P0 |
| G-3 | Обучение не отталкивает ребёнка | Завершение обучения до конца | >=85% стартовавших | P1 |
| G-4 | Долгосрочное удержание навыка | Повторная диагностика через неделю | >=75% удерживают 9/10 | P2 |

### 3.2 Таблица метрик успеха

| Категория | Метрика | Базовая линия | Цель | Способ измерения |
|-----------|---------|---------------|------|------------------|
| Обучение | % завершения истории | — | 85% | analytics/learningCompleted |
| Диагностика | % прохода с 9/10 | — | 80% | diagnosticPassRate |
| Диагностика | среднее число попыток | — | 1.5 | avgDiagnosticAttempts |
| Навык | ошибки в "перевороте" | ~40% | <10% | wrongOptionType tracking |
| Вовлечение | возврат к тренировке | — | 60% | returnToPracticeRate |

---

## 4. Non-Goals (Не является целью)

**Чего НЕ делаем:**

1. ❌ Не покрываем вычитание трёхзначных чисел (только двузначные вплоть до 100)
2. ❌ Не используем внешние графические движки (только Vue.js + CSS + SVG)
3. ❌ Не создаём режим соревновения multiplayer
4. ❌ Не реализуем адаптивную сложность на основе истории ошибок (v2)
5. ❌ Не покрываем случай "заимствование через ноль" (405-17) — только двузначные

---

## 5. User Personas (Персоны)

### 5.1 Максим, 8 лет (2 класс)

**Профиль:**
- Учится во 2 классе, только начали проходить вычитание в столбик
- Визуал: лучше понимает через картинки, чем через абстракции
- Боли: "Я не понимаю, откуда берётся десяток!", "5-7 нельзя!"

**Потребности:**
- Наглядная демонстрация заимствования
- Пояснение "почему" а не только "как"
- Безопасное пространство для ошибок

**Сценарий:**
> Максим застрял на примере 52-17. Он видит, что 2-7 нельзя, и просто пишет 5. Родители объясняют про занятие десятка, но это абстрактно. Упражнение "Магазин" показывает: в 52 — 5 пачек и 2 россыпи. Нужно сдать 7 россыпью. Вскрываем одну пачку → теперь 4 пачки и 12 россыпью. 12-7=5. Ага!

### 5.2 Соня, 9 лет (3 класс)

**Профиль:**
- Учится в 3 классе, уже знакома с вычитанием в столбик
- Делает ошибки из-за невнимательности (переворачивает числа)
- Мотивация: быстро пройти диагностику и начать тренировку

**Потребности:**
- Быстрая проверка знаний без долгого обучения
- Понятная обратная связь при ошибках
- Награды за прогресс

**Сценарий:**
> Соня проходит диагностику. На примере 45-27 автоматически выбирает 22 (переворот). Система показывает анимацию: "Из 45 вычитаем 27. Смотри: 5-7 нельзя, значит занимаем из десятков". Соня понимает ошибку и исправляет её.

### 5.3 Родитель (мама Максима)

**Профиль:**
- Хочет, чтобы ребёнок понимал математику, а не просто заучивал
- Устала объяснять одно и то же
- Доверяет интерактивным методам обучения

**Потребности:**
- Видеть прогресс ребёнка
- Понимать, где именно ребёнок застрял
- Быть уверенной, что материал усвоен

---

## 6. Functional Requirements (Функциональные требования)

### FR-001: Типы данных и генератор задач

**Описание:** Создать тип `ColumnSubtractionProblem` и генератор задач

**Требования:**
- Тип включает: minuend, subtrahend, result, needsBorrowing, borrowFromTens, hasZeroInUnits, expression, correctAnswer, options, correctIndex, difficulty
- Генератор поддерживает типы примеров: с заимствованием, с нулём в единицах, двузначный результат
- Генератор создаёт "перевёрнутый" ответ как ловушку (например, для 45-27 добавляет 22)
- 4 уровня сложности

**Приемочные критерии:**
- Все типы примеров генерируются корректно
- "Перевёрнутый" ответ присутствует в вариантах в ~50% случаев
- Уровни сложности влияют на диапазон чисел

**Файлы:** `src/types/index.ts`, `src/utils/math/columnSubtraction/index.ts`

---

### FR-002: Store и маршрутизация

**Описание:** Интеграция с существующей системой хранения и навигации

**Требования:**
- Добавить в `ScoresState`: `columnSubtractionScore`, `columnSubtractionLearningCompleted`
- Методы: `updateColumnSubtractionScore(points)`, `setLearningCompleted()`, `saveColumnSubtractionScore()`
- Маршруты: `/column-subtraction`, `/column-subtraction/learning`, `/column-subtraction/diagnostic`
- Добавить в `AvailableExercises`: grades 2-3, quarters 2-4

**Приемочные критерии:**
- Следует паттерну существующих упражнений
- Навигация работает корректно
- Состояние сохраняется в localStorage

**Файлы:** `src/store/scores.ts`, `src/router/index.ts`, `src/utils/gradeHelpers.ts`

---

### FR-003: Компонент ColumnDisplay

**Описание:** Визуализация столбика с числами

**Требования:**
- Отображение уменьшаемого (верхнее), вычитаемого (нижнее), черта
- Анимация заимствования (точка над разрядом)
- Подсветка активных разрядов при вычислении
- Адаптивный размер для мобильных

**Приемочные критерии:**
- Числа выровнены по разрядам
- Анимация плавная (CSS transition)
- Работает на мобильных устройствах

**Файл:** `src/components/columnSubtraction/ColumnDisplay.vue`

---

### FR-004: Компонент ShopVisualization

**Описание:** Метафора магазина с пачками и россыпью конфет

**Требования:**
- SVG-иконки: пачка (запечатанная), открытая пачка, отдельная конфета
- CSS-анимация вскрытия пачки → конфеты высыпаются
- Пересчёт после вскрытия с визуальным подсчётом
- Отображение: X пачек + Y россыпью

**Приемочные критерии:**
- Анимация занимает 2-3 секунды
- Понятно ребёнку 7-8 лет
- Работает без external graphics libraries

**Файлы:** `src/components/columnSubtraction/ShopVisualization.vue`, `src/components/columnSubtraction/svgIcons.ts`

---

### FR-005: Компонент LearningStory

**Описание:** Интерактивная история "Магазин" с 4 шагами

**Требования:**
- **Шаг 1:** "У тебя 5 конфет россыпью, нужно отдать 7. Что сделаешь?"
  - Варианты: "Вскрою пачку", "Отдам 5", "Нельзя"
- **Шаг 2:** "Сколько пачек вскроешь?" → выбор: 3/2/1
- **Шаг 3:** "Сколько конфет стало россыпью?" → выбор: 5/10/15
- **Шаг 4:** "15-7=?" → ввод числа
- Обратная связь при ошибке: объяснение почему неправильно
- Невозможно пропустить шаг

**Приемочные критерии:**
- Все 4 шага проходят последовательно
- Ошибка показывает объяснение
- Прогресс сохраняется

**Файл:** `src/components/columnSubtraction/LearningStory.vue`

---

### FR-006: Обучающий режим (Learning View)

**Описание:** Полноэкранная история "Магазин"

**Требования:**
- Полноэкранный режим без отвлекающих элементов
- Последовательное прохождение 4 шагов
- Кнопка "Далее" появляется только после правильного ответа
- При завершении → запись в store: `learningCompleted = true`
- Кнопка "Выйти" возвращает на HomeView

**Приемочные критерии:**
- Соответствует storyboard из плана
- Переход к диагностике после завершения
- Сохранение прогресса

**Файл:** `src/views/ColumnSubtractionLearningView.vue`

---

### FR-007: Диагностический режим

**Описание:** Оценка готовности к тренировке (10 примеров)

**Требования:**
- 10 примеров разных типов:
  - 3 с заимствованием из десятков (52-17)
  - 3 с двузначным результатом (33-18)
  - 2 с нулём в единицах (40-13)
  - 2 смешанных
- Критерий прохода: 9/10 правильно
- При неудаче → редирект на обучение
- При успехе → переход к тренировке

**Приемочные критерии:**
- Все типы примеров присутствуют
- Подсчёт 9/10 работает точно
- Редирект при неудаче

**Файл:** `src/views/ColumnSubtractionDiagnosticView.vue`

---

### FR-008: Тренировочный режим

**Описание:** Основной режим тренировки с подсказками

**Требования:**
- Стандартный столбик (ColumnDisplay)
- Кнопка "Показать что происходит" → ShopVisualization
- Подсказки при ошибке:
  - "Верхнее число — твои конфеты"
  - "Нужно занять из десятков"
- Использует `useGameLogic` для очков
- Интеграция с системой монет

**Приемочные критерии:**
- Следует паттерну других упражнений
- Подсказки контекстные
- Монеты начисляются корректно

**Файл:** `src/views/ColumnSubtractionView.vue`

---

### FR-009: Интеграция с HomeView

**Описание:** Карточка упражнения на главном экране

**Требования:**
- Карточка "Вычитание в столбик"
- Логика кнопки:
  - Не прошёл обучение → "Начать обучение"
  - Прошёл обучение, не диагностику → "Проверить знания"
  - Прошёл диагностику → "Тренироваться"
- Иконка: столбик или конфета

**Приемочные критерии:**
- Следует паттерну других карточек
- Кнопка меняется корректно

**Файл:** `src/views/HomeView.vue`

---

### FR-010: Логика переходов между режимами

**Описание:** State machine для трёх режимов

**Требования:**
```
[Обучение: Магазин]
    ↓
[Диагностика: 10 примеров]
    ↓
9/10 правильно?
/         \
Да         Нет
↓           ↓
[Тренировка] → [Обучение]
```

**Приемочные критерии:**
- Переходы работают в обе стороны
- Состояние сохраняется между сессиями

---

## 7. Implementation Phases (Этапы реализации)

### Phase 1: Foundation (Фундамент) — 2 дня

**Задачи:**
- Типы `ColumnSubtractionProblem`
- Генератор задач
- Store и routing
- Интеграция в AvailableExercises

**Dependencies:** Нет

---

### Phase 2: Visualization Components (Визуализация) — 3 дня

**Задачи:**
- ColumnDisplay.vue
- ShopVisualization.vue
- SVG icons (candyPack, candyPackOpen, candy)
- Unit testing компонентов

**Dependencies:** Phase 1

---

### Phase 3: Learning Mode (Обучение) — 2 дня

**Задачи:**
- LearningStory.vue
- ColumnSubtractionLearningView.vue
- Интеграция со store (learningCompleted)

**Dependencies:** Phase 2

---

### Phase 4: Diagnostic Mode (Диагностика) — 2 дня

**Задачи:**
- ColumnSubtractionDiagnosticView.vue
- Логика 9/10
- Редиректы

**Dependencies:** Phase 1

---

### Phase 5: Training Mode (Тренировка) — 2 дня

**Задачи:**
- ColumnSubtractionView.vue
- Интеграция с useGameLogic
- Подсказки
- Монеты

**Dependencies:** Phase 2

---

### Phase 6: Integration & Testing (Интеграция и тесты) — 2 дня

**Задачи:**
- HomeView integration
- E2E тесты
- Unit tests для генератора
- QA

**Dependencies:** Phase 3, 4, 5

---

**Итого:** ~13 дней разработки

---

## 8. Risks & Mitigations (Риски и mitigations)

| Риск | Вероятность | Влияние | Mitigation |
|------|-------------|---------|------------|
| Анимация магазина слишком сложная для понимания | Medium | High | Раннее user testing с детьми 2-3 класса |
| Дети "пробивают" диагностику без понимания | High | Medium | Добавить random questions из разных типов |
| SVG иконки не выглядят как конфеты | Low | Medium | Use simple geometric shapes + labels |
| Производительность на слабых устройствах | Low | Medium | Оптимизировать CSS анимации |
| Слишком долгое обучение (children drop off) | Medium | High | Keep learning <5 minutes |

---

## 9. Existing Patterns Reference (Ссылка на паттерны)

При реализации следовать существующим паттернам MathTrainer:

- **Game Logic:** `src/composables/useGameLogic.ts`
- **Problem Generator Pattern:** `src/utils/math/decomposition/index.ts`
- **Score Pattern:** `src/store/scores.ts` (добавить columnSubtractionScore)
- **Routing:** `src/router/index.ts` (meta.exerciseType)
- **Common Components:** AnswerOptions, ScoreDisplay, GameOver

---

## Appendix A: Type Definitions

```typescript
interface ColumnSubtractionProblem {
  minuend: number;           // Уменьшаемое (верхнее число)
  subtrahend: number;        // Вычитаемое (нижнее число)
  result: number;            // Разность
  needsBorrowing: boolean;   // Требуется заимствование из десятков
  borrowFromTens: boolean;   // Заимствование из десятков
  hasZeroInUnits: boolean;   // Ноль в единицах уменьшаемого (40-13)
  expression: string;        // "52 - 17"
  correctAnswer: number;     // 35
  options: string[];         // ["35", "45", "25", "33"]
  correctIndex: number;      // 0
  difficulty: number;        // 1-10
}
```

---

## Appendix B: Storyboard "Магазин"

### Шаг 1: Проблема
- **Текст:** "У тебя 5 конфет россыпью. Нужно отдать 7. Что сделаешь?"
- **Визуал:** 5 отдельных конфет, пустое место для 7
- **Варианты:** "Вскрою пачку" ✓ / "Отдам 5" ✗ / "Нельзя" ✗

### Шаг 2: Решение
- **Текст:** "Сколько пачек вскроешь?"
- **Визуал:** 3 запечатанные пачки
- **Варианты:** "3" ✗ / "2" ✗ / "1" ✓

### Шаг 3: Подсчёт
- **Текст:** "Сколько конфет стало россыпью?"
- **Визуал:** 2 запечатанные пачки + 12 россыпью
- **Варианты:** "5" ✗ / "10" ✗ / "15" ✓ (12 было бы слишком просто)

### Шаг 4: Результат
- **Текст:** "15 - 7 = ?"
- **Визуал:** 15 конфет, анимация вычитания 7
- **Ввод:** "8" ✓

---

**PRD Version:** 1.0
**Last Updated:** 2026-02-07
**Score:** 92/100
